# roles/security_script/tasks/main.yml
# ì¡°ì¹˜(enforce) ì‹œë‚˜ë¦¬ì˜¤

- name: Create base directory for security scripts
  file:
    path: /opt/security
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy run_all.sh
  copy:
    src: run_all.sh          # roles/security_script/files/run_all.sh ë¥¼ ìžë™ìœ¼ë¡œ ì°¾ìŒ
    dest: /opt/security/run_all.sh
    owner: root
    group: root
    mode: '0755'

- name: Copy fixes directory
  copy:
    src: fixes/              # roles/security_script/files/fixes/ ë¥¼ ìžë™ìœ¼ë¡œ ì°¾ìŒ
    dest: /opt/security/fixes/
    owner: root
    group: root
    mode: '0755'

- name: Run security script
  shell: |
    cd /opt/security
    ./run_all.sh

# ðŸ”Ž 1ë‹¨ê³„: ì›ê²© ì„œë²„ì—ì„œ audit ë¡œê·¸ íŒŒì¼ ëª©ë¡ ì°¾ê¸°
- name: Find audit log files
  find:
    paths: /opt/security/logs
    patterns: "vuln_fix_*.log"           # ë˜ëŠ” "*.log" ë¡œ ì „ì²´ ê°€ì ¸ì™€ë„ ë¨
    file_type: file
  register: fix_logs

# ðŸ“¥ 2ë‹¨ê³„: ì°¾ì€ íŒŒì¼ë“¤ì„ ì»¨íŠ¸ë¡¤ ë…¸ë“œë¡œ ê°€ì ¸ì˜¤ê¸°
- name: Fetch fix logs to control node
  fetch:
    src: "{{ item.path }}"
    dest: "./collected_logs/{{ inventory_hostname }}/"
    flat: yes                              # íŒŒì¼ ì´ë¦„ë§Œ ìœ ì§€í•˜ê³  í‰í‰í•˜ê²Œ ì €ìž¥
  loop: "{{ fix_logs.files }}"
  when: fix_logs.matched | default(0) > 0