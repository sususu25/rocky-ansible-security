# roles/security_script/tasks/audit.yml
# ì˜¤ë”§(Audit) ì‹œë‚˜ë¦¬ì˜¤

- name: Create base directory for security scripts
  file:
    path: /opt/security
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create log directory
  file:
    path: /opt/security/logs
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy audit script
  copy:
    src: run_audit.sh              # roles/security_script/files/run_audit.sh
    dest: /opt/security/run_audit.sh
    owner: root
    group: root
    mode: '0755'

- name: Run audit script
  shell: |
    cd /opt/security
    ./run_audit.sh
  register: audit_result

# ğŸ” 1ë‹¨ê³„: ì›ê²© ì„œë²„ì—ì„œ audit ë¡œê·¸ íŒŒì¼ ëª©ë¡ ì°¾ê¸°
- name: Find audit log files
  find:
    paths: /opt/security/logs
    patterns: "vuln_audit_*.log"
    file_type: file
  register: audit_logs

# ğŸ“¥ 2ë‹¨ê³„: ì°¾ì€ íŒŒì¼ë“¤ì„ ì»¨íŠ¸ë¡¤ ë…¸ë“œë¡œ ê°€ì ¸ì˜¤ê¸°
- name: Fetch audit logs to control node
  fetch:
    src: "{{ item.path }}"
    dest: "./collected_logs/{{ inventory_hostname }}/"
    flat: yes
  loop: "{{ audit_logs.files | default([]) }}"
